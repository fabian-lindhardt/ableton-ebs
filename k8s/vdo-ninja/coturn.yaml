apiVersion: v1
kind: ConfigMap
metadata:
  name: coturn-config
  namespace: vdo-ninja
data:
  turnserver.conf: |
    listening-port=3478
    tls-listening-port=5349
    fingerprint
    lt-cred-mech
    user=vdo:ninja-secret-password  # CHANGE THIS!
    realm=vdo.example.com           # CHANGE THIS!
    total-quota=100
    stale-nonce=600
    no-stdout-log
    log-file=/var/tmp/turn.log
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: coturn
  namespace: vdo-ninja
spec:
  replicas: 1
  selector:
    matchLabels:
      app: coturn
  template:
    metadata:
      labels:
        app: coturn
    spec:
      containers:
        - name: coturn
          image: coturn/coturn:latest
          ports:
            - containerPort: 3478
              protocol: UDP
            - containerPort: 3478
              protocol: TCP
            - containerPort: 5349
              protocol: UDP
            - containerPort: 5349
              protocol: TCP
          volumeMounts:
            - name: config
              mountPath: /etc/coturn/turnserver.conf
              subPath: turnserver.conf
      volumes:
        - name: config
          configMap:
            name: coturn-config
---
apiVersion: v1
kind: Service
metadata:
  name: coturn
  namespace: vdo-ninja
spec:
  selector:
    app: coturn
  ports:
    - name: turn-udp
      port: 3478
      protocol: UDP
    - name: turn-tcp
      port: 3478
      protocol: TCP
  type: LoadBalancer # Or NodePort if no LoadBalancer is available
